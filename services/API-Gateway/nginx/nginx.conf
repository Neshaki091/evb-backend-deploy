# ========================================================
# 1. ƒê·ªäNH NGHƒ®A V√ôNG GI·ªöI H·∫†N REQUEST (Rate Limit Zone)
# ========================================================
# T√™n zone: mylimit
# Key (kh√≥a): $binary_remote_addr (IP c·ªßa client)
# K√≠ch th∆∞·ªõc: 10m (10 Megabytes, ƒë·ªß cho kho·∫£ng 160.000 IP)
# T·ªëc ƒë·ªô: 10r/s (10 request m·ªói gi√¢y)
limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;

# ========================================================
# ƒê·ªäNH NGHƒ®A UPSTREAM (Gi·ªØ nguy√™n)
# ========================================================
upstream auth_service {
    server auth-service:3000;
}
upstream listing_service {
    server listing-service:5000;
}
upstream review_service {
    server review-service:8000;
}
upstream search_service {
    server search-service:8004;
}
upstream transaction_service {
    server transaction-service:3001;
}
upstream reports_service {
    server reports-service:8001;
}
upstream wishlist_service {
    server wishlist-service:8002;
}
upstream analytics_service {
    server analytics-service:8003;
}
upstream auction_service {
    server auction-service:8070;
}
server {
    listen 80;

    # ========================================================
    # 2. √ÅP D·ª§NG GI·ªöI H·∫†N REQUEST (Apply Rate Limit)
    # ========================================================
    # √Åp d·ª•ng zone 'mylimit' ƒë√£ ƒë·ªãnh nghƒ©a ·ªü tr√™n
    # burst=20: Cho ph√©p v∆∞·ª£t qu√° gi·ªõi h·∫°n 20 request (ch√∫ng s·∫Ω ƒë∆∞·ª£c x·∫øp h√†ng)
    # nodelay: X·ª≠ l√Ω c√°c request burst ngay l·∫≠p t·ª©c thay v√¨ tr√¨ ho√£n
    limit_req zone=mylimit burst=20 nodelay;

    # ... (CORS & OPTIONS - Gi·ªØ nguy√™n)
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

    if ($request_method = 'OPTIONS') {
        return 204;
    }
    # ========================================================
    # 2. PROXY PASS ƒê∆†N GI·∫¢N (KH√îNG D√ôNG REWRITE)
    # ========================================================

    # üîë AUTH Service: /api/auth/login -> /users/login
    location /api/auth/ {
        # S·ª¨A L·ªñI: Ch·ªâ ƒë·ªãnh ƒë∆∞·ªùng d·∫´n g·ªëc mong mu·ªën c·ªßa Auth Service
        proxy_pass http://auth_service/;
        proxy_set_header Authorization $http_authorization;
    }

    # üöó LISTING Service: /api/listings/* -> /*
    location /api/listings/ {
        # Do listing route th∆∞·ªùng b·∫Øt ƒë·∫ßu t·ª´ / (v√≠ d·ª•: /public), ta ch·ªâ ƒë·ªãnh /
        proxy_pass http://listing_service/;
        proxy_set_header Authorization $http_authorization;
    }

    # üí∞ TRANSACTION Service (Member Routes): /api/transactions/* -> /orders/*
    location /api/transactions/ {
        # S·ª¨A L·ªñI: Ch·ªâ ƒë·ªãnh r√µ r√†ng th∆∞ m·ª•c route /orders/
        proxy_pass http://transaction_service/orders/;
        proxy_set_header Authorization $http_authorization;
    }

    # üîí ADMIN TRANSACTION Routes: /api/admin/transactions/* -> /admin/*
    location /api/admin/transactions/ {
        # Ch·ªâ ƒë·ªãnh r√µ r√†ng th∆∞ m·ª•c route /admin/
        proxy_pass http://transaction_service/admin/;
        proxy_set_header Authorization $http_authorization;
    }
    # Th√™m logic Admin Fees tr·ª±c ti·∫øp (N·∫øu Transaction Service c√≥ endpoint /admin/fees)
    location /api/admin/fees/ {
        proxy_pass http://transaction_service/admin/fees/;
        proxy_set_header Authorization $http_authorization;
    }
    # ----------------------------------------------------
    # REVIEW, WISHLIST, REPORTS, ANALYTICS (T·∫•t c·∫£ ƒë·ªÅu proxy v·ªÅ g·ªëc /)
    # ----------------------------------------------------

    # üí¨ REVIEW Service
    location /api/reviews/ {
        proxy_pass http://review_service/;
        proxy_set_header Authorization $http_authorization;
    }

    # ‚≠ê WISHLIST Service
    location /api/wishlist/ {
        proxy_pass http://wishlist_service/;
        proxy_set_header Authorization $http_authorization;
    }

    # üö® REPORTS Service
    location /api/reports/ {
        proxy_pass http://reports_service/;
        proxy_set_header Authorization $http_authorization;
    }

    # üìà ANALYTICS Service
    location /api/analytics/ {
        proxy_pass http://analytics_service/;
        proxy_set_header Authorization $http_authorization;
    }

    # üîç SEARCH Service
    location /api/search/ {
        # Gi·ªØ nguy√™n nh∆∞ c≈©, gi·∫£ ƒë·ªãnh Search Service x·ª≠ l√Ω path
        proxy_pass http://search_service/;
        proxy_set_header Authorization $http_authorization;
    }
        # üè∑Ô∏è AUCTION Service
    location /api/auctions/ {
        proxy_pass http://auction_service/;
        proxy_set_header Authorization $http_authorization;
    }
}